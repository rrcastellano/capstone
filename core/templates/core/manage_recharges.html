{% extends 'core/layout.html' %}
{% load i18n %}
{% load custom_filters %}

{% block content %}
<h2 class="page-title mb-4"><i class="fa fa-history me-2"></i> {% trans "Histórico de Recargas" %}</h2>

<div class="card mb-4">
    <div class="card-header bg-light" data-bs-toggle="collapse" data-bs-target="#filterCollapse"
        style="cursor: pointer;">
        <i class="fas fa-filter me-1"></i> {% trans "Filtros" %}
        <i class="fas fa-chevron-down float-end mt-1"></i>
    </div>
    <div class="collapse" id="filterCollapse">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <input type="hidden" name="periodo" value="{{ filters.periodo }}">
                <div class="col-md-2">
                    <label class="form-label">{% trans "Data Início" %}</label>
                    <input type="date" name="data_inicio" class="form-control" value="{{ filters.data_inicio }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{% trans "Data Fim" %}</label>
                    <input type="date" name="data_fim" class="form-control" value="{{ filters.data_fim }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{% trans "Local" %}</label>
                    <input type="text" name="local" class="form-control" placeholder="{% trans 'Local...' %}"
                        value="{{ filters.local }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">{% trans "Observações" %}</label>
                    <input type="text" name="observacoes" class="form-control" placeholder="{% trans 'Texto...' %}"
                        value="{{ filters.observacoes }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">{% trans "Isento" %}</label>
                    <select name="isento" class="form-select">
                        <option value="">{% trans "Todos" %}</option>
                        <option value="True" {% if filters.isento == True %}selected{% endif %}>Sim</option>
                        <option value="False" {% if filters.isento == False %}selected{% endif %}>Não</option>
                    </select>
                </div>

                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> {% trans "Aplicar Filtro" %}</button>
                    <a href="{% url 'manage_recharges' %}" class="btn btn-secondary ms-2"><i class="fas fa-times"></i>
                        {% trans "Limpar" %}</a>
                    <a href="?periodo=30d" class="btn btn-info ms-2 text-white"><i class="fas fa-calendar-alt"></i> {% trans "Últimos 30 dias" %}</a>
                    <button type="submit" name="export" value="csv" class="btn btn-success ms-2 float-end"><i
                            class="fas fa-file-csv"></i> {% trans "Exportar CSV" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>{% trans "Data" %}</th>
                <th>{% trans "Local" %}</th>
                <th>{% trans "kWh" %}</th>
                <th>{% trans "Custo" %}</th>
                <th class="d-none d-md-table-cell">{% trans "Odômetro" %}</th>
                <th>{% trans "Status" %}</th>
                <th class="d-none d-md-table-cell">{% trans "Observações" %}</th>
                <th>{% trans "Ações" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for r in recharges %}
            <tr>
                <td>{{ r.data|date_fmt }}</td>
                <td>{{ r.local|default:"-" }}</td>
                <td>{{ r.kwh }}</td>
                <td>{{ r.custo|brl }}</td>
                <td class="d-none d-md-table-cell">{{ r.odometro|default:"-" }}</td>
                <td>
                    {% if r.isento %}
                    <span class="badge bg-success">{% trans "Isento" %}</span>
                    {% else %}
                    <span class="badge bg-secondary">{% trans "Pago" %}</span>
                    {% endif %}
                </td>
                <td class="d-none d-md-table-cell">{{ r.observacoes|default:"-" }}</td>
                <td>
                    <a href="{% url 'edit_recharge' r.id %}" class="btn btn-sm btn-primary me-2"
                        title="{% trans 'Editar' %}">
                        <i class="fa fa-edit"></i>
                    </a>
                    <a href="{% url 'delete_recharge' r.id %}" class="btn btn-sm btn-danger"
                        onclick="return confirm('{% trans 'Tem certeza que deseja excluir esta recarga?' %}');">
                        <i class="fa fa-trash"></i>
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center text-muted">{% trans "Nenhuma recarga registrada." %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if recharges.has_other_pages %}
<nav aria-label="Navegação de página">
    <ul class="pagination justify-content-center">
        {% if recharges.has_previous %}
        <li class="page-item">
            <a class="page-link"
                href="?page={{ recharges.previous_page_number }}&local={{ filters.local }}&observacoes={{ filters.observacoes }}&isento={{ filters.isento }}&data_inicio={{ filters.data_inicio }}&data_fim={{ filters.data_fim }}&periodo={{ filters.periodo }}"
                aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
        </li>
        {% endif %}

        {% for i in recharges.paginator.page_range %}
        {% if recharges.number == i %}
        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link"
                href="?page={{ i }}&local={{ filters.local }}&observacoes={{ filters.observacoes }}&isento={{ filters.isento }}&data_inicio={{ filters.data_inicio }}&data_fim={{ filters.data_fim }}&periodo={{ filters.periodo }}">{{ i }}</a></li>
        {% endif %}
        {% endfor %}

        {% if recharges.has_next %}
        <li class="page-item">
            <a class="page-link"
                href="?page={{ recharges.next_page_number }}&local={{ filters.local }}&observacoes={{ filters.observacoes }}&isento={{ filters.isento }}&data_inicio={{ filters.data_inicio }}&data_fim={{ filters.data_fim }}&periodo={{ filters.periodo }}"
                aria-label="Próximo">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
</div>
{% endblock %}